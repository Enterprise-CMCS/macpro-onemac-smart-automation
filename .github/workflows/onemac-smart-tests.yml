name: OneMAC SMART Test Suite
run-name: "OneMAC SMART Tests"

on:
  push:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: excel-sync
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  test:
    runs-on: ubuntu-latest

    env:
      OSG_QA_USERNAME: ${{ secrets.OSG_QA_USERNAME }}
      PASSWORD: ${{ secrets.PASSWORD }}
      APP_PASSWORD: ${{ secrets.APP_PASSWORD }}
      OSG_QA_SECRET: ${{ secrets.OSG_QA_SECRET }}
      EMAIL: ${{ secrets.EMAIL }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Cache Maven dependencies
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: Set browser and headless from config
        shell: pwsh
        run: |
          $configPath = "src/test/resources/config.properties"
          $browser = (Select-String -Path $configPath -Pattern "browser\s*=").ToString().Split("=")[1].Trim()
          $headless = (Select-String -Path $configPath -Pattern "headless\s*=").ToString().Split("=")[1].Trim()

          Add-Content -Path $env:GITHUB_ENV -Value "BROWSER=$browser"
          Add-Content -Path $env:GITHUB_ENV -Value "HEADLESS=$headless"

      - name: Run OneMAC Smart Suite
        shell: pwsh
        continue-on-error: true
        run: |
          $suiteFile = "src/test/resources/OneMACSmart.xml"
          Write-Output "Running E2E Suite with suite file: $suiteFile"

          & mvn clean test `
            "-DsuiteXmlFile=$suiteFile" `
            "-Dtestng.parameters.browser=$env:BROWSER" `
            "-Dtestng.parameters.headless=$env:HEADLESS" `
            "-Duser.timezone=America/New_York"

      - name: Upload Extent Report & Screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: OneMAC-SMART-Report
          path: |
            extent-report/**
            screenshots/**
          if-no-files-found: warn

      - name: Configure Git Identity
        if: always()
        shell: pwsh
        run: |
          git config user.name "Amjad"
          git config user.email "jad.ammar.co@gmail.com"

      - name: Stage environment files
        shell: pwsh
        run: |
          $configPath = "src/test/resources/config.properties"

          if (!(Test-Path $configPath)) {
            Write-Output "config.properties not found!"
            exit 1
          }

          $runOnLine = Select-String -Path $configPath -Pattern "^runOn\s*="
          $runOn = $runOnLine.ToString().Split("=")[1].Trim()

          if (-not $runOn) {
            Write-Output "runOn not set in config.properties"
            exit 1
          }

          $counterFile = "src/test/resources/state_counters_$runOn.xlsx"
          $packagesFile = "src/test/resources/packages_$runOn.xlsx"

          $updated = 0

          if (Test-Path $counterFile) {
            git add $counterFile
            $updated = 1
          }

          if (Test-Path $packagesFile) {
            git add $packagesFile
            $updated = 1
          }

          Add-Content -Path $env:GITHUB_ENV -Value "UPDATED=$updated"
          Add-Content -Path $env:GITHUB_ENV -Value "RUNON_ENV=$runOn"

      - name: Commit & Push Excel Updates
        if: always()
        shell: pwsh
        run: |
          if ($env:UPDATED -eq "1") {
            if (-not (git diff --cached --quiet)) {
              git commit -m "CI: Update Excel counters for $env:RUNON_ENV environment"
              git fetch origin main
              git pull origin main --rebase
              git push origin HEAD:main
            }
          }


      - name: Extract Test Summary
        if: always()
        shell: bash
        run: |
          FILE="extent-report/OneMAC-SMART-TestReport.json"

          if [ -f "$FILE" ]; then
            PASSED=$(jq '[.[] | select(.status == "PASS")] | length' "$FILE")
            FAILED=$(jq '[.[] | select(.status == "FAIL")] | length' "$FILE")
            SKIPPED=$(jq '[.[] | select(.status == "SKIP")] | length' "$FILE")
          else
            PASSED=0
            FAILED=0
            SKIPPED=0
          fi

          TOTAL=$((PASSED + FAILED + SKIPPED))

          if [ "$TOTAL" -gt 0 ]; then
            PASS_RATE=$((PASSED * 100 / TOTAL))
          else
            PASS_RATE=0
          fi

          echo "PASSED=$PASSED" >> $GITHUB_ENV
          echo "FAILED=$FAILED" >> $GITHUB_ENV
          echo "SKIPPED=$SKIPPED" >> $GITHUB_ENV
          echo "TOTAL=$TOTAL" >> $GITHUB_ENV
          echo "PASS_RATE=$PASS_RATE" >> $GITHUB_ENV

      - name: Send Extent Report Email
        if: always()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.EMAIL }}
          password: ${{ secrets.APP_PASSWORD }}
          subject: "OneMAC SMART Automation Report"
          to: Amjad.Ammar@icf.com
          from: OneMAC-SMART CI
          html_body: |
            <body style="margin:0; padding:0; font-family:Segoe UI, Arial; background:#f5f7fb;">
            
              <table width="100%" cellpadding="0" cellspacing="0" style="background:#f5f7fb; padding:20px;">
                <tr>
                  <td align="center">
            
                    <table width="700" cellpadding="0" cellspacing="0" 
                           style="background:#ffffff; border-radius:8px;">
            
                      <!-- HEADER -->
                      <tr>
                        <td style="background:#1f3a5f; color:white; padding:20px; border-radius:8px 8px 0 0;">
                          <h2 style="margin:0;">OneMAC SMART Automation</h2>
                        </td>
                      </tr>
            
                      <!-- SUMMARY -->
                      <tr>
                        <td style="padding:20px;">
                          <table width="100%" cellpadding="10" cellspacing="0">
                            <tr>
            
                              <td align="center" style="background:#eafaf1; border-radius:6px;">
                                <h2 style="color:#27ae60; margin:0;">${{ env.PASSED }}</h2>
                                <p style="margin:0;">Passed</p>
                              </td>
            
                              <td align="center" style="background:#fdecea; border-radius:6px;">
                                <h2 style="color:#e74c3c; margin:0;">${{ env.FAILED }}</h2>
                                <p style="margin:0;">Failed</p>
                              </td>
            
                              <td align="center" style="background:#fff8e1; border-radius:6px;">
                                <h2 style="color:#f39c12; margin:0;">${{ env.SKIPPED }}</h2>
                                <p style="margin:0;">Skipped</p>
                              </td>
            
                            </tr>
                          </table>
                        </td>
                      </tr>
            
                      <!-- PASS RATE -->
                      <tr>
                        <td style="padding:0 20px 20px 20px;">
                          <table width="100%" cellpadding="15" cellspacing="0"
                                 style="background:#f0f4ff; border-radius:6px;">
                            <tr>
                              <td align="center">
                                <h1 style="margin:0; color:#2E86C1;">
                                  ${{ env.PASS_RATE }}%
                                </h1>
                                <p style="margin:0;">Overall Pass Rate</p>
                              </td>
                            </tr>
                          </table>
                        </td>
                      </tr>
            
                      <!-- DETAILS -->
                      <tr>
                        <td style="padding:0 20px 20px 20px;">
                          <table width="100%" cellpadding="8" cellspacing="0"
                                 style="border:1px solid #e5e7eb; border-collapse:collapse;">
                            <tr>
                              <td style="padding:8px; font-weight:bold;">Total Tests:</td>
                              <td style="padding:8px;">${{ env.TOTAL }}</td>
                            </tr>
            
                            <tr>
                              <td style="padding:8px; font-weight:bold;">Environment:</td>
                              <td style="padding:8px;">${{ env.RUNON_ENV }}</td>
                            </tr>
            
                            <tr>
                              <td style="padding:8px; font-weight:bold;">Repository:</td>
                              <td style="padding:8px;">${{ github.repository }}</td>
                            </tr>
                          </table>
                        </td>
                      </tr>
            
                      <!-- BUTTON -->
                      <tr>
                        <td align="center" style="padding:20px;">
                          <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                             style="background:#2E86C1; color:white; padding:12px 25px; 
                                    text-decoration:none; border-radius:5px;">
                             View Full Report
                          </a>
                        </td>
                      </tr>
            
                      <!-- FOOTER -->
                      <tr>
                        <td align="center" style="font-size:12px; color:#999; padding:15px;">
                          Generated automatically by GitHub Actions CI.
                        </td>
                      </tr>
            
                    </table>
            
                  </td>
                </tr>
              </table>
            
            </body>
